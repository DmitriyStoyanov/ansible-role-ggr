---
# This is an example playbook to execute Ansible tests.
- name: Verify
  hosts: all
  tasks:
    - name: Configure Go Grid Router quota
      copy:
        dest: '/home/ggr/go-grid-router/quota'
        src: '/builds/lean-delivery/ansible-role-ggr/files/ggr-config-example.xml'
        mode: 0664
        owner: 'ggr'
        group: 'ggr'
      become: true

    - name: Reset failed ggr
      command: systemctl reset-failed ggr.service
      become: true

    - name: Reset failed ggr-ui
      command: systemctl reset-failed ggr-ui.service
      become: true

    - name: Reset failed selenoid-ui
      command: systemctl reset-failed selenoid-ui.service
      become: true

    - name: Restart selenoid-ui.service
      systemd:
        state: restarted
        name: selenoid-ui
      become: true

    - name: Restart ggr.service
      systemd:
        state: restarted
        name: ggr
      become: true

    - name: Restart ggr-ui.service
      systemd:
        state: restarted
        name: ggr-ui
      become: true

    - name: Restart ggr-ui.service
      systemd:
        state: restarted
        name: ggr-ui
      become: true

    - name: Populate service facts
      service_facts:

    - name: Assert that ggr services are running
      assert:
        that:
          - "'running' in ansible_facts.services['ggr.service'].state"
          - "'running' in ansible_facts.services['ggr-ui.service'].state"
